// Detect n8n binary execution or Node.js running n8n across all platforms
#event_simpleName=ProcessRollup2
| in(field="FileName", values=[n8n, n8n.exe, node.exe, node, npm, npm.exe, npx, npx.exe], ignoreCase=true)
| CommandLine=/n8n/i

// Extract clean filename
| ImageFileName=/(\/|\\)(?<CleanFileName>\w*\.?\w*)$/

// Build process lineage for context
| ProcessLineage:=format(format="%s > %s > %s", field=[GrandParentBaseFileName, ParentBaseFileName, FileName])

// Aggregate by key attributes
| groupBy([aid, ComputerName, UserName, CommandLine, ProcessLineage, SHA256HashData], function=[
    count(as=execCount), 
    min(@timestamp, as=firstSeen), 
    max(@timestamp, as=lastSeen),
    collect([TargetProcessId], limit=5)
])

// Format timestamps
| formatTime(format="%Y-%m-%d %H:%M:%S", field=firstSeen, as=firstSeenTime)
| formatTime(format="%Y-%m-%d %H:%M:%S", field=lastSeen, as=lastSeenTime)

// Create investigation links
| RTR:=format("[RTR Console](https://falcon.crowdstrike.com/activity/real-time-response/console/?aid=%s)", field=[aid])
| VirusTotal:=format("[VT](https://www.virustotal.com/gui/file/%s)", field=[SHA256HashData])
| ProcessExplorer:=format("[PE](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=[aid, TargetProcessId])

// Sort by execution frequency
| sort(execCount, order=desc)

// Table output
| table([ComputerName, UserName, ProcessLineage, CommandLine, execCount, firstSeenTime, lastSeenTime, RTR, VirusTotal])


/*Hunting for n8n installation*/
// Detect npm/npx installing or initializing n8n
#event_simpleName=ProcessRollup2
| in(field="FileName", values=[npm, npm.exe, npx, npx.exe, yarn, yarn.exe, pnpm, pnpm.exe], ignoreCase=true)
| CommandLine=/n8n/i

// Extract installation type
| case {
    CommandLine=/install.*n8n/i | InstallType:="npm install";
    CommandLine=/npx.*n8n/i | InstallType:="npx run";
    CommandLine=/add.*n8n/i | InstallType:="yarn/pnpm add";
    * | InstallType:="other";
}

// Group by installation details
| groupBy([aid, ComputerName, UserName, InstallType, CommandLine], function=[
    count(as=installAttempts),
    selectLast([@timestamp, SHA256HashData, TargetProcessId])
])

// Format timestamp
| formatTime(format="%Y-%m-%d %H:%M:%S", field=@timestamp, as=installTime)

// Create links
| RTR:=format("[RTR Console](https://falcon.crowdstrike.com/activity/real-time-response/console/?aid=%s)", field=[aid])
| ProcessExplorer:=format("[Explore Process](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=[aid, TargetProcessId])

// Sort by most recent
| sort(@timestamp, order=desc)


/*Query 3: Hunt for n8n Network Activity (Port 5678)*/

// Correlate n8n process execution with network connections on default port
(#event_simpleName=NetworkConnectIP4 RemotePort=5678) OR 
(#event_simpleName=NetworkListenIP4 LocalPort=5678) OR 
(#event_simpleName=ProcessRollup2 CommandLine=/n8n/i)

// Normalize process ID fields
| falconPID:=TargetProcessId 
| falconPID:=ContextProcessId

// Join network events with process events
| selfJoinFilter(field=[aid, falconPID], where=[
    {#event_simpleName=/^Network/}, 
    {#event_simpleName=ProcessRollup2}
])

// Aggregate connection data
| groupBy([aid, ComputerName, falconPID], function=[
    collect([ImageFileName, CommandLine, UserName, RemoteAddressIP4, RemotePort, LocalPort, LocalAddressIP4, Protocol]),
    count(RemoteAddressIP4, distinct=true, as=uniqueRemoteIPs),
    count(as=connectionCount)
])

// Ensure we have process details
| ImageFileName=*

// Exclude RFC1918 private ranges to focus on external connections
| !cidr(RemoteAddressIP4, subnet=["10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8", "169.254.0.0/16"])

// Enrich with GeoIP data
| ipLocation(RemoteAddressIP4)

// Create investigation links
| RTR:=format("[RTR Console](https://falcon.crowdstrike.com/activity/real-time-response/console/?aid=%s)", field=[aid])
| ProcessExplorer:=format("[Process Explorer](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=[aid, falconPID])

// Table output
| table([ComputerName, UserName, ImageFileName, RemoteAddressIP4, RemotePort, "RemoteAddressIP4.country", connectionCount, uniqueRemoteIPs, RTR, ProcessExplorer])

Query 4: Hunt for n8n DNS Activity (Noisy)

// Detect DNS requests from n8n-related processes
#event_simpleName=/^(DnsRequest|ProcessRollup2)$/

// Normalize PID fields
| case {
    TargetProcessId=* | falconPID:=TargetProcessId;
    ContextProcessId=* | falconPID:=ContextProcessId;
}

// Self-join to correlate DNS with process
| selfJoinFilter(field=[aid, falconPID], where=[
    {#event_simpleName=DnsRequest},
    {#event_simpleName=ProcessRollup2 CommandLine=/n8n/i}
], prefilter=true)

// Group by process and collect DNS requests
| groupBy([aid, ComputerName, falconPID], function=[
    collect([ImageFileName, CommandLine, UserName, DomainName]),
    count(DomainName, distinct=true, as=uniqueDomains),
    count(as=totalRequests)
])

// Ensure we have required fields
| ImageFileName=* DomainName=*

// Filter out common noise domains (customize for your environment)
| DomainName!=/ocsp\.digicert\.com|localhost|arpa$/i

// Create investigation links
| ProcessExplorer:=format("[Process Explorer](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=[aid, falconPID])

// Table output with domain details
| table([ComputerName, UserName, ImageFileName, DomainName, uniqueDomains, totalRequests, ProcessExplorer])

Query 5: Hunt for n8n File Activity (.n8n Directory)

// Detect file writes to .n8n configuration directories
#event_simpleName=FileWritten
| TargetFileName=/(\\|\/)\.n8n/i

// Convert file size to human-readable format
| case {
    Size>=1099511627776 | FileSize:=unit:convert(Size, to=T) | format("%,.2f TB", field=[FileSize], as=FileSize);
    Size>=1073741824 | FileSize:=unit:convert(Size, to=G) | format("%,.2f GB", field=[FileSize], as=FileSize);
    Size>=1048576 | FileSize:=unit:convert(Size, to=M) | format("%,.2f MB", field=[FileSize], as=FileSize);
    Size>=1024 | FileSize:=unit:convert(Size, to=K) | format("%,.2f KB", field=[FileSize], as=FileSize);
    * | format("%d B", field=[Size], as=FileSize);
}

// Aggregate file writes
| groupBy([aid, ComputerName, UserName, TargetFileName], function=[
    count(as=writeCount),
    sum(Size, as=totalBytes),
    selectLast([@timestamp])
])

// Format timestamp
| formatTime(format="%Y-%m-%d %H:%M:%S", field=@timestamp, as=lastWrite)

// Create RTR link
| RTR:=format("[RTR Console](https://falcon.crowdstrike.com/activity/real-time-response/console/?aid=%s)", field=[aid])

// Sort by write frequency
| sort(writeCount, order=desc)

// Table output
| table([ComputerName, UserName, TargetFileName, FileSize, writeCount, lastWrite, RTR])

Query 6: Frequency Analysis - Rare n8n Deployments (Noisy)

// Find n8n executions on low numbers of endpoints (potential testing/malicious)
#event_simpleName=ProcessRollup2
| CommandLine=/n8n/i
| ImageFileName=/(\/|\\)(?<FileName>\w*\.?\w*)$/

// Aggregate by binary hash
| groupBy([FileName, CommandLine, SHA256HashData], function=[
    count(aid, distinct=true, as=uniqueEndpoints),
    count(aid, as=totalExecutions),
    collect([ComputerName], limit=20)
])

// Filter for low-prevalence (adjust threshold as needed)
| uniqueEndpoints<=10

// Sort by rarest first
| sort(uniqueEndpoints, order=asc)

// Create threat intel links
| VirusTotal:=format("[VirusTotal](https://www.virustotal.com/gui/file/%s)", field=[SHA256HashData])
| HybridAnalysis:=format("[Hybrid Analysis](https://www.hybrid-analysis.com/search?query=%s)", field=[SHA256HashData])

// Table output
| table([FileName, uniqueEndpoints, totalExecutions, ComputerName, CommandLine, VirusTotal, HybridAnalysis])

Query 7: n8n with Suspicious Parent Processes

// Detect n8n spawned from unexpected parent processes
#event_simpleName=ProcessRollup2
| CommandLine=/n8n/i


// Exclude legitimate parent processes
| !in(field="ParentBaseFileName", values=[
    cmd.exe, powershell.exe, pwsh.exe, bash, sh, zsh, fish,
    explorer.exe, terminal, Code.exe, WindowsTerminal.exe,
    wt.exe, ConEmu64.exe, services.exe, svchost.exe
], ignoreCase=true)


// Build process tree
| ProcessTree:=format(format="%s\n  └─ %s\n     └─ %s", field=[GrandParentBaseFileName, ParentBaseFileName, FileName])


// Aggregate suspicious spawns
| groupBy([aid, ComputerName, UserName, ParentBaseFileName, CommandLine, ProcessTree], function=[
    count(as=spawnCount),
    selectLast([TargetProcessId, u/timestamp])
])


// Format timestamp
| formatTime(format="%Y-%m-%d %H:%M:%S", field=@timestamp, as=lastSeen)


// Create investigation links
| ProcessExplorer:=format("[Process Explorer](https://falcon.crowdstrike.com/investigate/process-explorer/%s/%s)", field=[aid, TargetProcessId])


// Sort by frequency
| sort(spawnCount, order=desc)


// Table output
| table([ComputerName, UserName, ParentBaseFileName, ProcessTree, CommandLine, spawnCount, lastSeen, ProcessExplorer])

Query 8: Comprehensive n8n Dashboard Query (Noisy)

// Multi-faceted n8n activity dashboard
#event_simpleName=ProcessRollup2
| CommandLine=/n8n/i

// Extract execution context
| ImageFileName=/(\/|\\)(?<FileName>\w*\.?\w*)$/
| ProcessLineage:=format(format="%s > %s > %s", field=[GrandParentBaseFileName, ParentBaseFileName, FileName])

// Categorize activity type
| case {
    CommandLine=/start/i | ActivityType:="Service Start";
    CommandLine=/webhook/i | ActivityType:="Webhook";
    CommandLine=/import/i | ActivityType:="Workflow Import";
    CommandLine=/export/i | ActivityType:="Workflow Export";
    * | ActivityType:="Other";
}

// Aggregate comprehensive stats
| groupBy([ActivityType, ComputerName, UserName], function=[
    count(as=executionCount),
    count(aid, distinct=true, as=uniqueHosts),
    min(@timestamp, as=firstSeen),
    max(@timestamp, as=lastSeen),
    collect([CommandLine, SHA256HashData], limit=5)
])

// Format timestamps
| formatTime(format="%Y-%m-%d %H:%M:%S", field=firstSeen, as=firstSeenTime)
| formatTime(format="%Y-%m-%d %H:%M:%S", field=lastSeen, as=lastSeenTime)

// Sort by activity type and count
| sort([ActivityType, executionCount], order=[asc, desc])
